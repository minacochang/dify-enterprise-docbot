# 設計判断とトレードオフ

## なぜ SQLite + FTS5 か

- **軽量**: 依存が少なく、単一ファイルで運用しやすい
- **同梱**: 外部サービス不要でオフラインでも動作
- **FTS5**: SQLite 標準の全文検索。BM25 スコアが使える

**トレードオフ**: 大規模・多言語・ベクトル検索には向かない。現状のドキュメント規模（数百〜千件）では十分。

## なぜ Vector DB なしか

- スコープを「ドキュメント検索」に限定
- セマンティック検索より「キーワード＋N-gram」で要件を満たせる
- 依存・運用の簡素化

**トレードオフ**: 言い換え検索・類似文検索は弱い。必要なら将来 Vector を追加する余地あり。

## なぜ N-gram で日本語検索か

- 日本語は単語境界が曖昧。形態素解析なしで実装を簡潔にできる
- 2/3-gram で部分一致を実現し、誤検索を抑える
- headings / body_prefix に限定して N-gram を生成し、インデックス肥大化を防ぐ

**トレードオフ**: 長いクエリでは N-gram 数が増え、OR が緩くなりノイズが出る場合がある。`MAX_NGRAM_TERMS` で上限を設けている。

## 制約

| 項目 | 制約 |
|------|------|
| 対象 | enterprise-docs.dify.ai の 3-0-x、ja-jp / en-us のみ |
| クロール | 最大 800 ページ、depth 8 |
| compose | 検索結果 or フォールバックの docker-compose.yaml のみ |
| helm | helm CLI 必須。フォールバックは langgenius/dify-helm |

---

[← Cursor ワークフロー](cursor-workflow.md) | [次: トラブルシューティング →](troubleshooting.md)
